# Some fancy echoing
CC           := g++
MAKEDEPEND   := makedepend

# Defines
DEFINES  := LITTLE_ENDIAN
CFLAGS   += $(patsubst %,-D%,$(DEFINES))
CPPFLAGS += $(patsubst %,-D%,$(DEFINES))

# Flags
CFLAGS   += --std=c99             # We code Standard C
CFLAGS   += -Wall                 # Enable many warnings
CFLAGS   += -Wextra               # Enable even more warnings
#CFLAGS   += -Werror               # Error out on warnings
CFLAGS   += -Wno-unused-parameter # Do not warn about unused function parameters

LDFLAGS  += --enable-auto-import -L/usr/lib -L.
LDLIBS   += -largtable2

SOURCE_DIRS  := . thirdparty
VPATH        := $(SOURCE_DIRS)
INCLUDE_DIRS := $(VPATH)
INCLUDE_DIRS += ../../fpga/leon3/software ../../fpga/leon3/grlib-W2000A/software/leon3 /usr/include
CFLAGS       += $(patsubst %,-I%,$(subst :, ,$(INCLUDE_DIRS)))
CPPFLAGS     += $(patsubst %,-I%,$(subst :, ,$(INCLUDE_DIRS)))

SOURCES      := $(foreach DIR, $(subst :, ,$(VPATH)), $(wildcard $(DIR)/*.c))
SOURCES      += $(foreach DIR, $(subst :, ,$(VPATH)), $(wildcard $(DIR)/*.cpp))

SOURCES      += ../../fpga/leon3/software/DSO_Remote.c
SOURCES      += ../../fpga/leon3/software/DSO_SignalCapture.c
SOURCES      += ../../fpga/leon3/software/DSO_Misc.c
SOURCES      += ../../fpga/leon3/software/DSO_Signal.c

HEADERS      := $(foreach DIR, $(subst :, ,$(VPATH)), $(wildcard $(DIR)/*.c))
OBJS         := $(SOURCES:.c=.o)
OBJS         := $(OBJS:.cpp=.o)
OBJDIR       := objs

DEPENDFILE   := depend
TARGET       := WaveRecorder

# Files to be cleaned
CLEAN := $(OBJDIR) $(OBJS) $(DEPENDFILE) $(DEPENDFILE:=.bak) $(TARGET)

.PHONY: all
all: $(TARGET)

$(TARGET): $(OBJS)

.PHONY: clean
clean:
	@echo " [CLEAN  ]"
	@$(RM) -r $(CLEAN)

.PHONY: $(OBJDIR)
$(OBJDIR):
	@mkdir -p $(patsubst %,$(OBJDIR)/%,$(SOURCE_DIRS))

%.o: %.c $(OBJDIR)
	@echo " [COMPILE] $<"
	@$(COMPILE.c) -o $(OBJDIR)/$(subst ../../fpga/leon3/software/,,$@) $<

%.o: %.cpp $(OBJDIR)
	@echo " [COMPILE] $<"
	@$(COMPILE.cpp) -o $(OBJDIR)/$(subst ../../fpga/leon3/software/,,$@) $<

%: %.o
	$(LINK.o) $(patsubst %,$(OBJDIR)/%,$(subst ../../fpga/leon3/software/,,$^)) $(LOADLIBES) -o $@ $(LDLIBS) 

# Dependencies

# We usually want a full remake when the Makefile changes
$(OBJS): Makefile

# Automatic dependency rule generation by makedepend
MAKEDEPEND_DELIMITER = "\# Do not edit this file, run make depend to update!"
$(DEPENDFILE): $(SOURCES) $(HEADERS)
	@echo " [DEPEND ]"
	@touch $@
	@$(MAKEDEPEND) -Y -m -s $(MAKEDEPEND_DELIMITER) -f $@ -- $(CFLAGS) $(LDFLAGS) -- $(SOURCES) >/dev/null 2>&1

include $(DEPENDFILE)
