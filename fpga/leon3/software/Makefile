# Programs to use
TOUCH      = @touch
ECHO       = @echo
#ECHO       = echo    # Uncomment this line to see the commands run.

# Some fancy echoing
CC         = $(ECHO) " [COMPILE] $<"; sparc-elf-gcc
LD         = $(ECHO) " [LINK   ] $<"; sparc-elf-gcc
OBJCOPY    = $(ECHO) " [OBJCOPY] $<"; sparc-elf-objcopy
SIZE       = $(ECHO) " [SIZE   ] $<"; sparc-elf-size
MAKEDEPEND = $(ECHO) " [DEPEND ]"; makedepend
WAVEREC    = $(ECHO) " [WAVEREC] "; WaveRecorder

# WaveRecorder settings
UART = /dev/ttyS0
BAUD = 115200
CHANNELS = 2
PROTOCOL = Debugger
COMMAND  = LoadRun

# Defines for conditional compilation
DSO_TARGET = W2000A
DSO_BOARD  = BOARD_COMPILATION
CPU        = LEON3
DEFINES    = -D$(CPU) -D$(DSO_TARGET) -D$(DSO_BOARD)

# Flags
CFLAGS  = $(DEFINES)
CFLAGS += --std=c99             # We code Standard C
CFLAGS += -msoft-float          # Use functions in libgcc.a to perform floating point operations
CFLAGS += -qsvt
CFLAGS += -mv8                  # Use V8 ISA
CFLAGS += -O2                   # Optimize some
CFLAGS += -Wall                 # Enable many warnings
CFLAGS += -Wextra               # Enable even more warnings
CFLAGS += -Werror               # Error out on warnings
CFLAGS += -Wno-unused-parameter # Do not warn about unused function parameters

# Target variables
SOURCE_DIRS   = . thirdparty fonts
VPATH	     := $(SOURCE_DIRS)
INCLUDE_DIRS := $(patsubst %,-I%,$(subst :, ,$(VPATH)))
INCLUDE_DIRS += -I../grlib-W2000A/software/leon3
CFLAGS       += $(INCLUDE_DIRS)

SOURCES := $(foreach DIR, $(subst :, ,$(VPATH)), $(wildcard $(DIR)/*.c))
HEADERS := $(foreach DIR, $(subst :, ,$(VPATH)), $(wildcard $(DIR)/*.h))
OBJS	:= $(SOURCES:.c=.o)
ASMS	:= $(SOURCES:.c=.s)

DEPENDFILE := depend
TARGET     := w2000a.bin

# Files to be cleaned
CLEAN = $(OBJS) $(ASMS) $(DEPENDFILE) $(DEPENDFILE:=.bak) $(TARGET)

# Rules
.PHONY: all
all: $(TARGET)

.PHONY: upload
upload: w2000a.bin
	$(WAVEREC) -p $(PROTOCOL) -u $(UART) -b $(BAUD) -n $(CHANNELS) -c $(COMMAND) --Ffile=$<

%.bin: %.elf
	$(OBJCOPY) -O binary $^ $@

%.elf: $(OBJS)
	$(LD) $(LDFLAGS) $^ -o $@
	@$(SIZE) $@

.PHONY: clean
clean:
	$(ECHO) " [CLEAN  ]"
	@$(RM) $(CLEAN)

# Dependencies

# We usually want a full remake when the Makefile changes
$(OBJS): Makefile

# Automatic dependency rule generation by makedepend
MAKEDEPEND_DELIMITER = "\# Do not edit this file, run make depend to update!"
$(DEPENDFILE): $(SOURCES) $(HEADERS)
	$(TOUCH) $@
	$(MAKEDEPEND) -Y -m -s $(MAKEDEPEND_DELIMITER) -f $@ -- $(CFLAGS) $(LDFLAGS) -- $(SOURCES) >/dev/null 2>&1

include $(DEPENDFILE)
